
variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

before_script:
  - export GRADLE_USER_HOME=`pwd`/.gradle

stages:
  - buildAndTest
  - deploy
  - document

build:
  stage: buildAndTest
  script:
    - cd Code
    - ./gradlew buildAndTestApp
  cache:
    key: "$CI_COMMIT_REF_NAME-App"
    policy: pull-push
    paths:
      - .gradle/wrapper
      - Code/Server/build-cache
      - Code/Client/Desktop/build-cache
      - Code/Client/Android/build-cache
      - Code/Client/iOS/Supporting Files/build-cache
      - Code/Server/build
      - Code/Shared/build
      - Code/Lib/multi-mvp/build
      - Code/Client/Desktop/build
      - Code/Client/Shared/build
      - Code/Client/iOS/Example/build
      - Code/Client/iOS/Supporting Files/build
      - Code/Client/Android/tv/build
      - Code/Client/Android/android-client-shared/build
      - Code/Client/Android/mobile/build
      - Code/Client/Android/build
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - Code/Server/build/*.war
      - Code/Client/Desktop/build/*.zip
      - Code/Client/Android/tv/build/outputs/apk/**/*.apk
      - Code/Client/Android/mobile/build/outputs/apk/**/*.apk
      - Code/Client/iOS/Example/build/**/*.ipa
    reports:
      junit:
        - Code/Server/build/reports/**/*.xml
        - Code/Shared/build/reports/**/*.xml
        - Code/Lib/multi-mvp/build/reports/**/*.xml
        - Code/Client/Desktop/build/reports/**/*.xml
        - Code/Client/Shared/build/reports/**/*.xml
        - Code/Client/Android/android-client-shared/build/reports/**/*.xml
        - Code/Client/Android/mobile/build/reports/**/*.xml

deploy-server:
  only:
    - master
  stage: deploy
  script:
    - cd Code
    - ./gradlew deployOnlyApp
    - cp Server/build/libs/Server-0.0.1.war /var/lib/jetty/webapps/root.war
  cache:
    key: "${CI_COMMIT_REF_NAME}-App"
    policy: pull
    paths:
      - Code/Server/build-cache
      - Code/Server/build
      - Code/Shared/build

  environment:
    name: staging
    url: https://example.chrishatton.org/api/

# document-client:
#   only:
#     - master
#   stage: document-client
#   script:
#     - cd Code/Client
#     - ./gradlew --build-cache dokka
#     - rm -rf /usr/share/nginx/html/example/doc/client/*
#     - cp -R build/javadoc/client/* /usr/share/nginx/html/example/doc/client
#     - cp build/javadoc/style.css /usr/share/nginx/html/example/doc
#   cache:
#     key: "$CI_COMMIT_REF_NAME"
#     policy: pull
#     paths:
#       - build
#       - .gradle

# Uses Kotlin's 'Dokka' plugin to generate and deploy documentation for the Server project
# (including the supporting 'Shared' framework)
document-server:
  only:
    - master
  stage: document
  script:
    - cd Code/Server
    - ./gradlew --build-cache dokka
    - mkdir -p /usr/share/nginx/html/example/doc/server/
    - rm -rf /usr/share/nginx/html/example/doc/server/*
    - cp -R build/javadoc/server/* /usr/share/nginx/html/example/doc/server/
    - cp build/javadoc/style.css /usr/share/nginx/html/example/doc/
  cache:
    key: "${CI_COMMIT_REF_NAME}-Server"
    policy: pull
    paths:
      - build
      - .gradle
